{"version":3,"sources":["../src/index.js"],"names":["BbPromise","require","path","slugify","chalk","semver","Runtimes","LayersService","BucketService","CloudFormationService","ZipService","LocalFolders","Dependencies","ServerlessLayers","serverless","options","cacheObject","initialized","hooks","bind","then","init","deployLayers","finalizeDeploy","cleanUpAllLayers","provider","getProvider","service","region","getRegion","log","main","version","getVersion","lt","process","exit","runtimes","settings","getSettings","cliOpts","layerName","currentSettings","enabledFuncs","functions","deploySingle","indexOf","logGroup","initServices","console","arn","warn","cleanUpLayers","currentLayerName","zipService","dependencies","localFolders","layersService","bucketService","cloudFormationService","inboundSetting","forceInstall","dependencyInstall","compileDir","customInstallationCommand","layersDeploymentBucket","deploymentBucket","getDefaultSettings","inboundSettings","custom","Array","isArray","forEach","Object","keys","mergeCommonSettings","hasSettingsVerified","localDir","manifest","JSON","stringify","getFile","remoteSettings","putFile","artifact","relateLayerWithFunctions","hasSettingsChanges","hasFoldersChanges","hasDepsChanges","hasDependenciesChanges","hasZipChanged","verifyChanges","some","x","mergePackageOptions","getLayerArn","existentLayerArn","skipInstallation","inverse","green","logArn","install","copyFolders","uploadZipFile","publishVersion","getDepsPath","LayerVersionArn","stackName","getStackName","runtimeDir","lower","replacement","naming","Error","join","cwd","getLayerName","serviceStage","stage","deploymentPrefix","getDeploymentPrefix","replace","layersArn","getOutputs","outputs","logicalId","getOutputLogicalId","find","OutputKey","OutputValue","getLambdaLayerOutputLogicalId","packageExclude","pkg","opts","individually","excludeDevDependencies","exclude","excludeFile","hasRule","push","layerArn","funcs","length","layers","magenta","bold","funcName","isEnabled","from","Set","noLayersMessage","resources","Outputs","outputName","assign","Value","Export","Name","localPackage","map","lambdaFunc","currentLayerARN","msg","signal","greenBright","white","cli","yellowBright","red","pattern","name","formated","text","Ref","String","module","exports"],"mappings":"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","sourcesContent":["const BbPromise = require('bluebird');\nconst path = require('path');\nconst slugify = require('slugify');\nconst chalk = require('chalk');\nconst semver = require('semver');\nconst Runtimes = require('./runtimes');\nconst LayersService = require('./aws/LayersService');\nconst BucketService = require('./aws/BucketService');\nconst CloudFormationService = require('./aws/CloudFormationService');\nconst ZipService = require('./package/ZipService');\nconst LocalFolders = require('./package/LocalFolders');\nconst Dependencies = require('./package/Dependencies');\n\nclass ServerlessLayers {\n  constructor(serverless, options) {\n    this.cacheObject = {};\n    this.options = options;\n    this.serverless = serverless;\n    this.initialized = false;\n\n    // hooks\n    this.hooks = {\n      'before:package:function:package': () => BbPromise.bind(this)\n        .then(() => {\n          return this.init()\n            .then(() => this.deployLayers())\n        }),\n      'before:package:initialize': () => BbPromise.bind(this)\n        .then(() => {\n          return this.init()\n            .then(() => this.deployLayers())\n        }),\n      'aws:info:displayLayers': () => BbPromise.bind(this)\n        .then(() => this.init())\n        .then(() => this.finalizeDeploy()),\n      'after:deploy:function:deploy': () => BbPromise.bind(this)\n        .then(() => this.init())\n        .then(() => this.finalizeDeploy()),\n      'plugin:uninstall:uninstall': () => BbPromise.bind(this)\n        .then(() => {\n          return this.init()\n            .then(() => this.cleanUpAllLayers())\n        }),\n      'remove:remove': () => BbPromise.bind(this)\n        .then(() => {\n          return this.init()\n            .then(() => this.cleanUpAllLayers())\n        })\n    };\n  }\n\n  async init() {\n    if (this.initialized) {\n      return;\n    }\n\n    this.provider = this.serverless.getProvider('aws');\n    this.service = this.serverless.service;\n    this.options.region = this.provider.getRegion();\n\n    // bindings\n    this.log = this.log.bind(this);\n    this.main = this.main.bind(this);\n\n    const version = this.serverless.getVersion();\n\n    if (semver.lt(version, '1.34.0')) {\n      this.log(`Error: Please install serverless >= 1.34.0 (current ${this.serverless.getVersion()})`);\n      process.exit(1);\n    }\n  }\n\n  async deployLayers() {\n    this.runtimes = new Runtimes(this);\n    const settings = this.getSettings();\n\n    const cliOpts = this.provider.options;\n\n    for (const layerName in settings) {\n      const currentSettings = settings[layerName];\n      const enabledFuncs = currentSettings.functions;\n\n      // deploying a single function\n      const deploySingle = !!(cliOpts.function && enabledFuncs);\n\n      // skip layers that is not related with specified function\n      if (deploySingle && enabledFuncs.indexOf(cliOpts.function) === -1) {\n        continue;\n      }\n\n      this.logGroup(layerName);\n      await this.initServices(layerName, currentSettings);\n      await this.main();\n    }\n\n    console.log('\\n');\n  }\n\n  async cleanUpAllLayers() {\n    this.runtimes = new Runtimes(this);\n    const settings = this.getSettings();\n    for (const layerName in settings) {\n      const currentSettings = settings[layerName];\n      this.logGroup(layerName);\n\n      if (currentSettings.arn) {\n        this.warn(` (skipped) arn: ${currentSettings.arn}`);\n        continue;\n      }\n\n      await this.initServices(layerName, currentSettings);\n      await this.cleanUpLayers();\n    }\n  }\n\n  async initServices(layerName, settings) {\n    this.currentLayerName = layerName;\n    this.settings = settings;\n    this.zipService = new ZipService(this);\n    this.dependencies = new Dependencies(this);\n    this.localFolders = new LocalFolders(this);\n    this.layersService = new LayersService(this);\n    this.bucketService = new BucketService(this);\n    this.cloudFormationService = new CloudFormationService(this);\n    this.initialized = true;\n  }\n\n  mergeCommonSettings(inboundSetting) {\n    return {\n      path: '.',\n      functions: null,\n      forceInstall: false,\n      dependencyInstall: true,\n      compileDir: '.serverless',\n      customInstallationCommand: null,\n      layersDeploymentBucket: this.service.provider.deploymentBucket,\n      ...this.runtimes.getDefaultSettings(inboundSetting)\n    };\n  }\n\n  getSettings() {\n    const inboundSettings = (this.serverless.service.custom || {})[\n      'serverless-layers'\n    ];\n\n    if (Array.isArray(inboundSettings)) {\n      const settings = {};\n      inboundSettings.forEach(inboundSetting => {\n        const layerName = Object.keys(inboundSetting)[0];\n        settings[layerName] = this.mergeCommonSettings(inboundSetting[layerName]);\n      });\n      return settings;\n    }\n\n    return {\n      default: this.mergeCommonSettings(inboundSettings)\n    }\n  }\n\n  hasSettingsChanges() {\n    // don't check settings changes twice\n    if (this.hasSettingsVerified) {\n      return false;\n    }\n\n    // by pass settings\n    if (!this.settings.localDir) {\n      return false;\n    }\n\n    const manifest = '__meta__/manifest-settings.json';\n    const currentSettings = JSON.stringify(this.settings);\n\n    // settings checked\n    this.hasSettingsVerified = true;\n\n    return this.bucketService.getFile(manifest).then((remoteSettings) => {\n\n      // create and return true (changed)\n      if (!remoteSettings) {\n        return this.bucketService.putFile(manifest, currentSettings)\n          .then(() => true);\n      }\n\n      if (remoteSettings !== currentSettings) {\n        return this.bucketService.putFile(manifest, currentSettings)\n          .then(() => true);\n      }\n\n      return false;\n    });\n  }\n\n  async main() {\n    const {\n      arn,\n      localDir,\n      artifact,\n      forceInstall,\n      dependencyInstall\n    } = this.settings;\n\n    // static ARN\n    if (arn) {\n      this.relateLayerWithFunctions(arn);\n      return;\n    }\n\n    await this.runtimes.init();\n    await this.dependencies.init();\n    await this.localFolders.init();\n\n    // it avoids issues if user changes some configuration\n    // which will not be applied till dependencies be changed\n    let hasSettingsChanges = await this.hasSettingsChanges();\n\n    // check if directories content has changed\n    // comparing hash md5 remote with local folder\n    let hasFoldersChanges = false;\n    if (localDir) {\n      hasFoldersChanges = await this.localFolders.hasFoldersChanges();\n    }\n\n    // check if dependencies has changed comparing\n    // remote package.json with local one\n    let hasDepsChanges = false;\n    if (dependencyInstall) {\n      hasDepsChanges = await this.runtimes.hasDependenciesChanges();\n    }\n\n    let hasZipChanged = false;\n    if (artifact) {\n      hasZipChanged = await this.zipService.hasZipChanged();\n    }\n\n    // It checks if something has changed\n    let verifyChanges = [\n      hasZipChanged,\n      hasDepsChanges,\n      hasFoldersChanges,\n      hasSettingsChanges\n    ].some(x => x === true);\n\n    // merge package default options\n    this.mergePackageOptions();\n\n    // It returns the layer arn if exists.\n    const existentLayerArn = await this.getLayerArn();\n\n    // It improves readability\n    const skipInstallation = (\n      !verifyChanges && !forceInstall && existentLayerArn\n    );\n\n    /**\n     * If no changes, and layer arn available,\n     * it doesn't require re-installing dependencies.\n     */\n    if (skipInstallation) {\n     this.log(`${chalk.inverse.green(' No changes ')}! Using same layer arn: ${this.logArn(existentLayerArn)}`);\n     this.relateLayerWithFunctions(existentLayerArn);\n     return;\n    }\n\n    // ENABLED by default\n    if (dependencyInstall && !artifact) {\n      await this.dependencies.install();\n    }\n\n    if (localDir && !artifact) {\n      await this.localFolders.copyFolders();\n    }\n\n    await this.zipService.package();\n    await this.bucketService.uploadZipFile();\n    const version = await this.layersService.publishVersion();\n    await this.bucketService.putFile(this.dependencies.getDepsPath());\n\n    this.relateLayerWithFunctions(version.LayerVersionArn);\n  }\n\n  getLayerName() {\n    const stackName = this.getStackName();\n    const { runtimeDir } = this.settings;\n    return slugify(`${stackName}-${runtimeDir}-${this.currentLayerName}`, {\n      lower: true,\n      replacement: '-'\n    });\n  }\n\n  getStackName() {\n    return this.provider.naming.getStackName();\n  }\n\n  getBucketName() {\n    if (!this.settings.layersDeploymentBucket) {\n      throw new Error(\n        'Please, you should specify \"deploymentBucket\" or \"layersDeploymentBucket\" option for this plugin!\\n'\n      );\n    }\n    return this.settings.layersDeploymentBucket;\n  }\n\n  getPathZipFileName() {\n    if (this.settings.artifact) {\n      return `${path.join(process.cwd(), this.settings.artifact)}`;\n    }\n    return `${path.join(process.cwd(), this.settings.compileDir, this.getLayerName())}.zip`;\n  }\n\n  getBucketLayersPath() {\n    const serviceStage = `${this.serverless.service.service}/${this.options.stage}`;\n\n    let deploymentPrefix = 'serverless';\n    if (this.provider.getDeploymentPrefix) {\n      deploymentPrefix = this.provider.getDeploymentPrefix();\n    }\n\n    return path.join(\n      deploymentPrefix,\n      serviceStage,\n      'layers'\n    ).replace(/\\\\/g, '/');\n  }\n\n  async getLayerArn() {\n    if (!this.cacheObject.layersArn) {\n      this.cacheObject.layersArn = {};\n    }\n\n    // returns cached arn\n    if (this.cacheObject.layersArn[this.currentLayerName]) {\n      return this.cacheObject.layersArn[this.currentLayerName];\n    }\n\n    const outputs = await this.cloudFormationService.getOutputs();\n\n    if (!outputs) return null;\n\n    const logicalId = this.getOutputLogicalId();\n\n    const arn = (outputs.find(x => x.OutputKey === logicalId) || {}).OutputValue;\n\n    // cache arn\n    this.cacheObject.layersArn[this.currentLayerName] = arn;\n\n    return arn;\n  }\n\n  getOutputLogicalId() {\n    return this.provider.naming.getLambdaLayerOutputLogicalId(this.getLayerName());\n  }\n\n  mergePackageOptions() {\n    const { packageExclude, artifact } = this.settings;\n    const pkg = this.service.package;\n\n    const opts = {\n      individually: false,\n      excludeDevDependencies: false,\n      exclude: []\n    };\n\n    this.service.package = {...opts, ...pkg};\n\n    for (const excludeFile of packageExclude) {\n      const hasRule = (this.service.package.exclude || '').indexOf(excludeFile);\n      if (hasRule === -1) {\n        this.service.package.exclude.push(excludeFile);\n      }\n    }\n\n    if (artifact) {\n      this.service.package.exclude.push(artifact);\n    }\n  }\n\n  relateLayerWithFunctions(layerArn) {\n    this.log('Adding layers...');\n    const { functions } = this.service;\n    const funcs = this.settings.functions;\n    const cliOpts = this.provider.options;\n\n    if (!funcs || !functions || funcs.length === functions.length) {\n      // if we are not specifying functions\n      // or if the service has no functions\n      // or we are specifying all functions of the service\n      // then add the layer to providers\n      if (this.service.provider.layers) {\n        this.service.provider.layers.push(layerArn);\n      } else {\n        this.service.provider.layers = [layerArn];\n      }\n      this.log(\n        `${chalk.magenta.bold('provider')} - ${this.logArn(layerArn)}`,\n        ' ✓'\n      );\n    }\n\n    Object.keys(functions).forEach(funcName => {\n      if (cliOpts.function && cliOpts.function !== funcName) {\n        return;\n      }\n\n      let isEnabled = !funcs;\n\n      if (Array.isArray(funcs) && funcs.indexOf(funcName) !== -1) {\n        isEnabled = true;\n      }\n\n      if (isEnabled && functions[funcName].layers) {\n        // if this function has other layers add ours too so it applies\n        functions[funcName].layers = functions[funcName].layers || [];\n        functions[funcName].layers.push(layerArn);\n        functions[funcName].layers = Array.from(new Set(functions[funcName].layers));\n        this.log(`function.${chalk.magenta.bold(funcName)} - ${this.logArn(layerArn)}`, ' ✓');\n      } else {\n        // otherwise please skip this function so the provider.layers can take care of it\n        const noLayersMessage = functions[funcName].layers ? '' : ' - because it has no other layers'\n        this.warn(`(Skipped) function.${chalk.magenta.bold(funcName)}${noLayersMessage}`, ` x`);\n      }\n    });\n\n    this.service.resources = this.service.resources || {};\n    this.service.resources.Outputs = this.service.resources.Outputs || {};\n\n    const outputName = this.getOutputLogicalId();\n\n    Object.assign(this.service.resources.Outputs, {\n      [outputName]: {\n        Value: layerArn,\n        Export: {\n          Name: outputName\n        }\n      }\n    });\n  }\n\n  getDependenciesList() {\n    return Object.keys((this.localPackage.dependencies||[])).map(x => (\n      `${x}@${this.localPackage.dependencies[x]}`\n    ));\n  }\n\n  async finalizeDeploy() {\n    const cliOpts = this.provider.options;\n    this.logGroup(\"Layers Info\");\n    Object.keys(this.service.functions).forEach(funcName => {\n      const lambdaFunc = this.service.functions[funcName];\n      const layers = lambdaFunc.layers || [];\n\n      if (!cliOpts.function && layers.length === 0) {\n        this.warn(`(skipped) function.${chalk.magenta.bold(funcName)}`);\n        return;\n      }\n\n      layers.forEach((currentLayerARN) => {\n        if (cliOpts.function && cliOpts.function === funcName) {\n          this.log(`function.${chalk.magenta.bold(funcName)} = layers.${this.logArn(currentLayerARN)}`);\n          return;\n        }\n        this.log(`function.${chalk.magenta.bold(funcName)} = layers.${this.logArn(currentLayerARN)}`);\n      });\n    });\n    console.log('\\n');\n  }\n\n  log(msg, signal=' ○') {\n    console.log('...' + `${chalk.greenBright.bold(signal)} ${chalk.white(msg)}`);\n  }\n\n  logGroup(msg) {\n    console.log('\\n');\n    this.serverless.cli.log(`[ LayersPlugin ]: ${chalk.magenta.bold('=>')} ${chalk.greenBright.bold(msg)}`);\n  }\n\n  warn(msg, signal=' ∅') {\n    console.log('...' + chalk.yellowBright(`${chalk.yellowBright.bold(signal)} ${msg}`));\n  }\n\n  error(msg, signal=' ⊗') {\n    console.log('...' + chalk.red(`${signal} ${chalk.white.bold(msg)}`));\n  }\n\n  cleanUpLayers() {\n    return this.layersService.cleanUpLayers();\n  }\n\n  logArn(arn) {\n    let pattern = /arn:aws:lambda:([^:]+):([0-9]+):layer:([^:]+):([0-9]+)/g;\n    let region = chalk.bold('$1');\n    let name = chalk.magenta('$3');\n    let formated = chalk.white(`arn:aws:lambda:${region}:*********:${name}:$4`);\n\n    let text = \"\";\n    switch (typeof arn) {\n      case 'object':\n        if (arn.Ref) {\n          text = `logicalId:[${chalk.bold('Ref')}=`;\n          text += `${chalk.magenta(arn.Ref)}]`;\n        }\n        break;\n      case 'string':\n        text = arn;\n        break;\n      default:\n        text = String(arn);\n        break;\n    }\n    return text.replace(pattern, formated);\n  }\n}\n\nmodule.exports = ServerlessLayers;\n"],"file":"index.js"}