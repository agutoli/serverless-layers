{"version":3,"file":"ZipService.js","names":["fs","require","path","chalk","mkdirp","crypto","fsExtra","archiver","MAX_LAYER_MB_SIZE","AbstractService","ZipService","hashName","functionName","Promise","resolve","reject","hash","createHash","input","createReadStream","on","chunk","update","digest","artifact","plugin","settings","mName","getManifestName","getChecksum","currentChecksum","bucketService","getFile","remoteChecksum","log","inverse","yellow","putFile","compileDir","zipFileName","getPathZipFileName","layersDir","join","process","cwd","existsSync","Error","oldCwd","output","createWriteStream","zip","create","MB","pointer","toFixed","err","chdir","pipe","directory","finalize","then","module","exports"],"sources":["../../src/package/ZipService.js"],"sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst chalk = require('chalk');\nconst mkdirp = require('mkdirp');\nconst crypto = require('crypto');\nconst fsExtra = require('fs-extra');\nconst archiver = require('archiver');\n\nconst MAX_LAYER_MB_SIZE = 250;\n\nconst AbstractService = require('../AbstractService');\n\nclass ZipService extends AbstractService {\n  getManifestName(hashName) {\n    return `__meta__/manifest-zip-artifact__${this.functionName}.json`;\n  }\n\n  getChecksum(path) {\n    return new Promise(function (resolve, reject) {\n      const hash = crypto.createHash('md5');\n      const input = fs.createReadStream(path);\n\n      input.on('error', reject);\n\n      input.on('data', function (chunk) {\n        hash.update(chunk);\n      });\n\n      input.on('close', function () {\n        resolve(hash.digest('hex'));\n      });\n    });\n  }\n\n  async hasZipChanged() {\n    const { artifact } = this.plugin.settings;\n    const mName = this.getManifestName(artifact);\n\n    const currentChecksum = await this.getChecksum(artifact);\n    const remoteChecksum = await this.plugin.bucketService.getFile(mName);\n\n    // check if zip hash changed\n    if (remoteChecksum === currentChecksum) {\n      return false;\n    }\n\n    // It updates remote check sum\n    this.plugin.log(`${chalk.inverse.yellow(' Artifact changed ')}! Checksum=${currentChecksum}`);\n    await this.plugin.bucketService.putFile(mName, currentChecksum);\n\n    return true;\n  }\n\n  package() {\n    const { compileDir, artifact } = this.plugin.settings;\n    const zipFileName = this.plugin.getPathZipFileName();\n    const layersDir = path.join(process.cwd(), compileDir);\n\n    return new Promise((resolve, reject) => {\n      // it's a zip already\n      if (artifact) {\n        // It checks if file exists\n        if (!fs.existsSync(zipFileName)) {\n          throw Error(`Artifact not found \"${zipFileName}\".`);\n        }\n        return resolve();\n      }    \n  \n      const oldCwd = process.cwd();\n      const output = fs.createWriteStream(zipFileName);\n      const zip = archiver.create('zip');\n\n      output.on('close', () => {\n        const MB = (zip.pointer() / 1024 / 1024).toFixed(1);\n\n        if (MB > MAX_LAYER_MB_SIZE) {\n          this.plugin.log('Package error!');\n          throw new Error(\n            'Layers can\\'t exceed the unzipped deployment package size limit of 250 MB! \\n'\n          + 'Read more: https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html\\n\\n'\n          );\n        }\n\n        this.plugin.log(`Created layer package ${zipFileName} (${MB} MB)`);\n        resolve();\n      });\n\n      zip.on('error', (err) => {\n        reject(err);\n        process.chdir(oldCwd);\n      });\n\n      process.chdir(layersDir);\n\n      zip.pipe(output);\n\n      zip.directory('layers', false);\n\n      zip.finalize()\n        .then(() => {\n          process.chdir(oldCwd);\n        });\n    });\n  }\n}\n\nmodule.exports = ZipService;\n"],"mappings":"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"}