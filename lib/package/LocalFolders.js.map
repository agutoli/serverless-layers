{"version":3,"file":"LocalFolders.js","names":["path","require","fsExtra","mkdirp","hashElement","AbstractService","LocalFolders","layersPackageDir","getLayerPackageDir","sync","hashName","toLowerCase","settings","plugin","localDir","options","folders","files","getHash","then","hash","manifest","getManifestName","name","bucketService","getFile","remoteManifest","JSON","stringify","to","join","libraryFolder","from","resolve","copy","putFile","module","exports"],"sources":["../../src/package/LocalFolders.js"],"sourcesContent":["const path = require('path');\nconst fsExtra = require('fs-extra');\nconst mkdirp = require('mkdirp');\nconst { hashElement } = require('folder-hash');\n\nconst AbstractService = require('../AbstractService');\n\nclass LocalFolders extends AbstractService {\n  init() {\n    this.layersPackageDir = this.getLayerPackageDir();\n    return mkdirp.sync(this.layersPackageDir);\n  }\n\n  getManifestName(hashName) {\n    return `__meta__/manifest-localdir-${hashName.toLowerCase()}.json`;\n  }\n\n  async getHash() {\n    const { settings } = this.plugin;\n\n    if (!settings.localDir) {\n      return;\n    }\n\n    const options = {\n      folders: settings.localDir.folders,\n      files: settings.localDir.files\n    };\n\n    return hashElement(settings.localDir.path, options);\n  }\n\n  async hasFoldersChanges() {\n    return this.getHash().then((hash) => {\n      const manifest = this.getManifestName(hash.name);\n      return this.plugin.bucketService.getFile(manifest).then(remoteManifest => {\n        if (remoteManifest === JSON.stringify(hash)) {\n          // not changed\n          return false;\n        }\n        return true;\n      });\n    });\n  }\n\n  async copyFolders() {\n    const { settings } = this.plugin;\n\n    if (!settings.localDir) {\n      return;\n    }\n\n    await this.getHash()\n      .then((hash) => {\n        const manifest = this.getManifestName(hash.name);\n        const to = path.join(this.layersPackageDir, settings.libraryFolder, settings.localDir.name);\n        const from = path.resolve(settings.localDir.path);\n\n        return fsExtra.copy(from, to).then(() => {\n          return this.plugin.bucketService.putFile(manifest, JSON.stringify(hash));\n        });\n      });\n  }\n}\n\nmodule.exports = LocalFolders;\n"],"mappings":"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"}