{"version":3,"sources":["../../src/package/LocalFolders.js"],"names":["path","require","fsExtra","mkdirp","hashElement","AbstractService","LocalFolders","layersPackageDir","getLayerPackageDir","sync","hashName","toLowerCase","settings","plugin","localDir","options","folders","files","getHash","then","hash","manifest","getManifestName","name","bucketService","getFile","remoteManifest","JSON","stringify","to","join","libraryFolder","from","resolve","copy","putFile","module","exports"],"mappings":";;;;;;;;;;;;;;;;;;AAAA,IAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,IAAMC,OAAO,GAAGD,OAAO,CAAC,UAAD,CAAvB;;AACA,IAAME,MAAM,GAAGF,OAAO,CAAC,QAAD,CAAtB;;eACwBA,OAAO,CAAC,aAAD,C;IAAvBG,W,YAAAA,W;;AAER,IAAMC,eAAe,GAAGJ,OAAO,CAAC,oBAAD,CAA/B;;IAEMK,Y;;;;;;;;;;2BACG;AACL,WAAKC,gBAAL,GAAwB,KAAKC,kBAAL,EAAxB;AACA,aAAOL,MAAM,CAACM,IAAP,CAAY,KAAKF,gBAAjB,CAAP;AACD;;;oCAEeG,Q,EAAU;AACxB,kDAAqCA,QAAQ,CAACC,WAAT,EAArC;AACD;;;;;;;;;;AAGSC,gBAAAA,Q,GAAa,KAAKC,M,CAAlBD,Q;;oBAEHA,QAAQ,CAACE,Q;;;;;;;;AAIRC,gBAAAA,O,GAAU;AACdC,kBAAAA,OAAO,EAAEJ,QAAQ,CAACE,QAAT,CAAkBE,OADb;AAEdC,kBAAAA,KAAK,EAAEL,QAAQ,CAACE,QAAT,CAAkBG;AAFX,iB;iDAKTb,WAAW,CAACQ,QAAQ,CAACE,QAAT,CAAkBd,IAAnB,EAAyBe,OAAzB,C;;;;;;;;;;;;;;;;;;;;;;;;;;kDAIX,KAAKG,OAAL,GAAeC,IAAf,CAAoB,UAACC,IAAD,EAAU;AACnC,sBAAMC,QAAQ,GAAG,KAAI,CAACC,eAAL,CAAqBF,IAAI,CAACG,IAA1B,CAAjB;;AACA,yBAAO,KAAI,CAACV,MAAL,CAAYW,aAAZ,CAA0BC,OAA1B,CAAkCJ,QAAlC,EAA4CF,IAA5C,CAAiD,UAAAO,cAAc,EAAI;AACxE,wBAAIA,cAAc,KAAKC,IAAI,CAACC,SAAL,CAAeR,IAAf,CAAvB,EAA6C;AAC3C;AACA,6BAAO,KAAP;AACD;;AACD,2BAAO,IAAP;AACD,mBANM,CAAP;AAOD,iBATM,C;;;;;;;;;;;;;;;;;;;;;;;;;;;AAaCR,gBAAAA,Q,GAAa,KAAKC,M,CAAlBD,Q;;oBAEHA,QAAQ,CAACE,Q;;;;;;;;;uBAIR,KAAKI,OAAL,GACHC,IADG,CACE,UAACC,IAAD,EAAU;AACd,sBAAMC,QAAQ,GAAG,MAAI,CAACC,eAAL,CAAqBF,IAAI,CAACG,IAA1B,CAAjB;;AACA,sBAAMM,EAAE,GAAG7B,IAAI,CAAC8B,IAAL,CAAU,MAAI,CAACvB,gBAAf,EAAiCK,QAAQ,CAACmB,aAA1C,EAAyDnB,QAAQ,CAACE,QAAT,CAAkBS,IAA3E,CAAX;AACA,sBAAMS,IAAI,GAAGhC,IAAI,CAACiC,OAAL,CAAarB,QAAQ,CAACE,QAAT,CAAkBd,IAA/B,CAAb;AAEA,yBAAOE,OAAO,CAACgC,IAAR,CAAaF,IAAb,EAAmBH,EAAnB,EAAuBV,IAAvB,CAA4B,YAAM;AACvC,2BAAO,MAAI,CAACN,MAAL,CAAYW,aAAZ,CAA0BW,OAA1B,CAAkCd,QAAlC,EAA4CM,IAAI,CAACC,SAAL,CAAeR,IAAf,CAA5C,CAAP;AACD,mBAFM,CAAP;AAGD,iBATG,C;;;;;;;;;;;;;;;;;;EA7CiBf,e;;AA0D3B+B,MAAM,CAACC,OAAP,GAAiB/B,YAAjB","sourcesContent":["const path = require('path');\nconst fsExtra = require('fs-extra');\nconst mkdirp = require('mkdirp');\nconst { hashElement } = require('folder-hash');\n\nconst AbstractService = require('../AbstractService');\n\nclass LocalFolders extends AbstractService {\n  init() {\n    this.layersPackageDir = this.getLayerPackageDir();\n    return mkdirp.sync(this.layersPackageDir);\n  }\n\n  getManifestName(hashName) {\n    return `__meta__/manifest-localdir-${hashName.toLowerCase()}.json`;\n  }\n\n  async getHash() {\n    const { settings } = this.plugin;\n\n    if (!settings.localDir) {\n      return;\n    }\n\n    const options = {\n      folders: settings.localDir.folders,\n      files: settings.localDir.files\n    };\n\n    return hashElement(settings.localDir.path, options);\n  }\n\n  async hasFoldersChanges() {\n    return this.getHash().then((hash) => {\n      const manifest = this.getManifestName(hash.name);\n      return this.plugin.bucketService.getFile(manifest).then(remoteManifest => {\n        if (remoteManifest === JSON.stringify(hash)) {\n          // not changed\n          return false;\n        }\n        return true;\n      });\n    });\n  }\n\n  async copyFolders() {\n    const { settings } = this.plugin;\n\n    if (!settings.localDir) {\n      return;\n    }\n\n    await this.getHash()\n      .then((hash) => {\n        const manifest = this.getManifestName(hash.name);\n        const to = path.join(this.layersPackageDir, settings.libraryFolder, settings.localDir.name);\n        const from = path.resolve(settings.localDir.path);\n\n        return fsExtra.copy(from, to).then(() => {\n          return this.plugin.bucketService.putFile(manifest, JSON.stringify(hash));\n        });\n      });\n  }\n}\n\nmodule.exports = LocalFolders;\n"],"file":"LocalFolders.js"}