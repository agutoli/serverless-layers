{"version":3,"sources":["../../src/package/Dependencies.js"],"names":["fs","require","path","mkdirp","exec","execSync","copyFile","AbstractService","Dependencies","commands","npm","yarn","initialCwd","process","cwd","nodeJsDir","join","plugin","settings","compileDir","cmd","options","console","log","toString","filename","init","existsSync","Promise","resolve","copyErr","sync","copyProjectFile","packagePath","packageManager","chdir","run","module","exports"],"mappings":";;;;;;;;;;;;;;;;;;AAAA,IAAMA,EAAE,GAAGC,OAAO,CAAC,IAAD,CAAlB;;AACA,IAAMC,IAAI,GAAGD,OAAO,CAAC,MAAD,CAApB;;AACA,IAAME,MAAM,GAAGF,OAAO,CAAC,QAAD,CAAtB;;AACA,IAAMG,IAAI,GAAGH,OAAO,CAAC,eAAD,CAAP,CAAyBI,QAAtC;;AACA,IAAMC,QAAQ,GAAGL,OAAO,CAAC,cAAD,CAAxB,C,CAA0C;;;AAE1C,IAAMM,eAAe,GAAGN,OAAO,CAAC,oBAAD,CAA/B;;IAGMO,Y;;;;;;;;;;;;2BACG;AACL,WAAKC,QAAL,GAAgB;AACdC,QAAAA,GAAG,EAAE,0BADS;AAEdC,QAAAA,IAAI,EAAE;AAFQ,OAAhB;AAIA,WAAKC,UAAL,GAAkBC,OAAO,CAACC,GAAR,EAAlB;AACA,WAAKC,SAAL,GAAiBb,IAAI,CAACc,IAAL,CAAUH,OAAO,CAACC,GAAR,EAAV,EAAyB,KAAKG,MAAL,CAAYC,QAAZ,CAAqBC,UAA9C,EAA0D,QAA1D,EAAoE,QAApE,CAAjB;AACD;;;wBAEGC,G,EAAmB;AAAA,UAAdC,OAAc,uEAAJ,EAAI;AACrBC,MAAAA,OAAO,CAACC,GAAR,CAAYnB,IAAI,CAACgB,GAAD,EAAMC,OAAN,CAAJ,CAAmBG,QAAnB,EAAZ;AACD;;;oCAEeC,Q,EAAU;AAAA;;AACxB,WAAKC,IAAL;;AAEA,UAAI,CAAC1B,EAAE,CAAC2B,UAAH,CAAcF,QAAd,CAAL,EAA8B;AAC5B,aAAKR,MAAL,CAAYM,GAAZ,uBAA8BE,QAA9B;AACA,eAAO,IAAP;AACD;;AAED,aAAO,IAAIG,OAAJ,CAAY,UAACC,OAAD,EAAa;AAC9BvB,QAAAA,QAAQ,CAACmB,QAAD,EAAWvB,IAAI,CAACc,IAAL,CAAU,KAAI,CAACD,SAAf,EAA0BU,QAA1B,CAAX,EAAgD,UAACK,OAAD,EAAa;AACnE,cAAIA,OAAJ,EAAa,MAAMA,OAAN;AACb,iBAAOD,OAAO,EAAd;AACD,SAHO,CAAR;AAID,OALM,CAAP;AAMD;;;;;;;;;;;AAGC,qBAAKH,IAAL;AACA,qBAAKT,MAAL,CAAYM,GAAZ,CAAgB,4CAAhB;;uBAEMpB,MAAM,CAAC4B,IAAP,CAAY,KAAKhB,SAAjB,C;;;;uBACA,KAAKiB,eAAL,CAAqB,KAAKf,MAAL,CAAYC,QAAZ,CAAqBe,WAA1C,C;;;sBAEF,KAAKhB,MAAL,CAAYC,QAAZ,CAAqBgB,cAArB,KAAwC,K;;;;;;uBACpC,KAAKF,eAAL,CAAqB,mBAArB,C;;;sBAGJ,KAAKf,MAAL,CAAYC,QAAZ,CAAqBgB,cAArB,KAAwC,M;;;;;;uBACpC,KAAKF,eAAL,CAAqB,WAArB,C;;;AAGRnB,gBAAAA,OAAO,CAACsB,KAAR,CAAc,KAAKpB,SAAnB,E,CAEA;;AACA,qBAAKqB,GAAL,CAAS,KAAK3B,QAAL,CAAc,KAAKQ,MAAL,CAAYC,QAAZ,CAAqBgB,cAAnC,CAAT;AAEArB,gBAAAA,OAAO,CAACsB,KAAR,CAAc,KAAKvB,UAAnB;;;;;;;;;;;;;;;;;;EAlDuBL,e;;AAsD3B8B,MAAM,CAACC,OAAP,GAAiB9B,YAAjB","sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst mkdirp = require('mkdirp');\nconst exec = require('child_process').execSync;\nconst copyFile = require('fs-copy-file'); // node v6.10.3 support\n\nconst AbstractService = require('../AbstractService');\n\n\nclass Dependencies extends AbstractService {\n  init() {\n    this.commands = {\n      npm: 'npm install --production',\n      yarn: 'yarn --production'\n    };\n    this.initialCwd = process.cwd();\n    this.nodeJsDir = path.join(process.cwd(), this.plugin.settings.compileDir, 'layers', 'nodejs');\n  }\n\n  run(cmd, options = []) {\n    console.log(exec(cmd, options).toString());\n  }\n\n  copyProjectFile(filename) {\n    this.init();\n\n    if (!fs.existsSync(filename)) {\n      this.plugin.log(`[warning] \"${filename}\" file does not exists!`);\n      return true;\n    }\n\n    return new Promise((resolve) => {\n      copyFile(filename, path.join(this.nodeJsDir, filename), (copyErr) => {\n        if (copyErr) throw copyErr;\n        return resolve();\n      });\n    });\n  }\n\n  async install() {\n    this.init();\n    this.plugin.log('Dependencies has changed! Re-installing...');\n\n    await mkdirp.sync(this.nodeJsDir);\n    await this.copyProjectFile(this.plugin.settings.packagePath);\n\n    if (this.plugin.settings.packageManager === 'npm') {\n      await this.copyProjectFile('package-lock.json');\n    }\n\n    if (this.plugin.settings.packageManager === 'yarn') {\n      await this.copyProjectFile('yarn.lock');\n    }\n\n    process.chdir(this.nodeJsDir);\n\n    // packages installation\n    this.run(this.commands[this.plugin.settings.packageManager]);\n\n    process.chdir(this.initialCwd);\n  }\n}\n\nmodule.exports = Dependencies;\n"],"file":"Dependencies.js"}