{"version":3,"file":"nodejs.js","names":["path","require","NodeJSRuntime","parent","runtime","runtimeDir","plugin","libraryFolder","packageManager","packageManagerExtraArgs","dependenciesPath","compatibleRuntimes","compatibleArchitectures","copyBeforeInstall","packagePatterns","layerOptimization","cleanupPatterns","commands","npm","yarn","pnpm","settings","localpackageJson","join","process","cwd","localPackage","e","log","exit","run","osVersion","match","runtimeVersion","version","isCompatible","startsWith","depsA","depsB","depsKeyA","Object","keys","depsKeyB","isSizeEqual","length","hasDifference","forEach","dependence","bucketService","downloadDependencesFile","remotePackage","isDifferent","parsedRemotePackage","JSON","parse","dependencies","isDiff","module","exports"],"sources":["../../src/runtimes/nodejs.js"],"sourcesContent":["const path = require('path');\n\nclass NodeJSRuntime {\n  constructor(parent, runtime, runtimeDir) {\n    this.parent = parent;\n    this.plugin = parent.plugin;\n\n    this.default = {\n      runtime,\n      runtimeDir,\n      libraryFolder: 'node_modules',\n      packageManager:  'npm',\n      packageManagerExtraArgs: '',\n      dependenciesPath: 'package.json',\n      compatibleRuntimes: [runtimeDir],\n      compatibleArchitectures: parent.compatibleArchitectures,\n      copyBeforeInstall: [\n        '.npmrc',\n        'yarn.lock',\n        'package-lock.json'\n      ],\n      packagePatterns: [\n        '!node_modules/**',\n      ],\n      layerOptimization: {\n        cleanupPatterns: [\n          \"node_modules/aws-sdk/**\",\n          \"node_modules/**/.github\",\n          \"node_modules/**/.git/*\",\n          \"node_modules/**/.lint\",\n          \"node_modules/**/Gruntfile.js\",\n          \"node_modules/**/.jshintrc\",\n          \"node_modules/**/.nycrc\",\n          \"node_modules/**/.nvmrc\",\n          \"node_modules/**/.editorconfig\",\n          \"node_modules/**/.npmignore\",\n          \"node_modules/**/bower.json\",\n          \"node_modules/**/.eslint*\",\n          \"node_modules/**/.gitignore\",\n          \"node_modules/**/README.*\",\n          \"node_modules/**/LICENSE\",\n          \"node_modules/**/LICENSE.md\",\n          \"node_modules/**/CHANGES\",\n          \"node_modules/**/HISTORY.md\",\n          \"node_modules/**/CHANGES.md\",\n          \"node_modules/**/CHANGELOG.md\",\n          \"node_modules/**/sponsors.md\",\n          \"node_modules/**/license.txt\",\n          \"node_modules/**/tsconfig.json\",\n          \"node_modules/**/*.test.js\",\n          \"node_modules/**/*.spec.js\",\n          \"node_modules/**/.travis.y*ml\",\n          \"node_modules/**/yarn.lock\",\n          \"node_modules/**/.package-lock.json\",\n          \"node_modules/**/*.md\",\n        ]\n      }\n    };\n\n    this.commands = {\n      npm: 'npm install --production --only=prod',\n      yarn: 'yarn --production',\n      pnpm: 'pnpm install --prod'\n    };\n  }\n\n  init() {\n    const { dependenciesPath } = this.plugin.settings;\n\n    const localpackageJson = path.join(\n      process.cwd(),\n      dependenciesPath\n    );\n\n    try {\n      this.localPackage = require(localpackageJson);\n    } catch (e) {\n      this.plugin.log(`Error: Can not find ${localpackageJson}!`);\n      process.exit(1);\n    }\n  }\n\n  async isCompatibleVersion(runtime) {\n    const osVersion = await this.parent.run('node --version');\n    const [runtimeVersion] = runtime.match(/([0-9]+)\\./);\n    return {\n      version: osVersion,\n      isCompatible: osVersion.startsWith(`v${runtimeVersion}`)\n    };\n  }\n\n  isDiff(depsA, depsB) {\n    if (!depsA) {\n      return true;\n    }\n\n    const depsKeyA = Object.keys(depsA);\n    const depsKeyB = Object.keys(depsB);\n    const isSizeEqual = depsKeyA.length === depsKeyB.length;\n\n    if (!isSizeEqual) return true;\n\n    let hasDifference = false;\n    Object.keys(depsA).forEach(dependence => {\n      if (depsA[dependence] !== depsB[dependence]) {\n        hasDifference = true;\n      }\n    });\n\n    return hasDifference;\n  }\n\n  async hasDependenciesChanges() {\n    const remotePackage = await this.plugin.bucketService.downloadDependencesFile();\n\n    let isDifferent = true;\n\n    if (remotePackage) {\n      const parsedRemotePackage = JSON.parse(remotePackage);\n      const { dependencies } = parsedRemotePackage;\n      this.plugin.log('Comparing package.json dependencies...');\n      isDifferent = await this.isDiff(dependencies, this.localPackage.dependencies);\n    }\n\n    return isDifferent;\n  }\n}\n\nmodule.exports = NodeJSRuntime;\n"],"mappings":"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"}