{"version":3,"file":"ruby.js","names":["fs","require","path","RubyRuntime","parent","runtime","runtimeDir","plugin","libraryFolder","packageManager","packageManagerExtraArgs","dependenciesPath","compatibleRuntimes","compatibleArchitectures","copyBeforeInstall","copyAfterInstall","from","to","packagePatterns","layerOptimization","cleanupPatterns","commands","bundle","settings","localpackageJson","join","process","cwd","localPackage","readFileSync","toString","e","log","exit","run","osVersion","match","runtimeVersion","version","isCompatible","startsWith","depsA","depsB","bucketService","downloadDependencesFile","remotePackage","isDifferent","isDiff","module","exports"],"sources":["../../src/runtimes/ruby.js"],"sourcesContent":["const fs = require('fs');\nconst path = require('path');\n\n\nclass RubyRuntime {\n  constructor(parent, runtime, runtimeDir) {\n    this.parent = parent;\n    this.plugin = parent.plugin;\n\n    this.default = {\n      runtime,\n      runtimeDir,\n      libraryFolder: 'gems',\n      packageManager:  'bundle',\n      packageManagerExtraArgs: '',\n      dependenciesPath: 'Gemfile',\n      compatibleRuntimes: [runtime],\n      compatibleArchitectures: parent.compatibleArchitectures,\n      copyBeforeInstall: [\n        'Gemfile.lock'\n      ],\n      copyAfterInstall: [\n        { from: 'ruby', to: 'gems' }\n      ],\n      packagePatterns: [\n        '!node_modules/**',\n        '!package.json',\n        '!package-lock.json',\n        '!vendor/**',\n        '!.bundle'\n      ],\n      layerOptimization: {\n        cleanupPatterns: [\n          \"node_modules/**/*.pyc\",\n          \"node_modules/**/*.md\",\n        ]\n      }\n    };\n\n    this.commands = {\n      bundle: `bundle install --gemfile=${this.default.dependenciesPath} --path=./`,\n    };\n  }\n\n  init() {\n    const { dependenciesPath } = this.plugin.settings;\n\n    const localpackageJson = path.join(\n      process.cwd(),\n      dependenciesPath\n    );\n\n    try {\n      this.localPackage = fs.readFileSync(localpackageJson).toString();\n    } catch (e) {\n      this.plugin.log(`Error: Can not find ${localpackageJson}!`);\n      process.exit(1);\n    }\n  }\n\n  async isCompatibleVersion(runtime) {\n    const osVersion = await this.parent.run('ruby --version');\n    const [runtimeVersion] = runtime.match(/[0-9].[0-9]/);\n    return {\n      version: osVersion,\n      isCompatible: osVersion.startsWith(`ruby ${runtimeVersion}`)\n    };\n  }\n\n  isDiff(depsA, depsB) {\n    if (!depsA) {\n      return true;\n    }\n    return depsA !== depsB;\n  }\n\n  async hasDependenciesChanges() {\n    const remotePackage = await this.plugin.bucketService.downloadDependencesFile();\n\n    let isDifferent = true;\n\n    if (remotePackage) {\n      this.plugin.log(`Comparing ${this.default.dependenciesPath} dependencies...`);\n      isDifferent = await this.isDiff(remotePackage, this.localPackage);\n    }\n\n    return isDifferent;\n  }\n}\n\nmodule.exports = RubyRuntime;\n"],"mappings":"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"}