{"version":3,"file":"python.js","names":["fs","require","path","PythonRuntime","parent","runtime","runtimeDir","plugin","libraryFolder","packageManager","packageManagerExtraArgs","dependenciesPath","compatibleRuntimes","compatibleArchitectures","copyBeforeInstall","packagePatterns","layerOptimization","cleanupPatterns","commands","pip","settings","localpackageJson","join","process","cwd","localPackage","readFileSync","toString","e","log","exit","run","osVersion","match","runtimeVersion","version","isCompatible","startsWith","depsA","depsB","bucketService","downloadDependencesFile","remotePackage","isDifferent","isDiff","module","exports"],"sources":["../../src/runtimes/python.js"],"sourcesContent":["const fs = require('fs');\nconst path = require('path');\n\nclass PythonRuntime {\n  constructor(parent, runtime, runtimeDir) {\n    this.parent = parent;\n    this.plugin = parent.plugin;\n\n    this.default = {\n      runtime,\n      runtimeDir,\n      libraryFolder: 'site-packages',\n      packageManager:  'pip',\n      packageManagerExtraArgs: '',\n      dependenciesPath: 'requirements.txt',\n      compatibleRuntimes: [runtime],\n      compatibleArchitectures: parent.compatibleArchitectures,\n      copyBeforeInstall: [],\n      packagePatterns: [\n        '!package.json',\n        '!package-lock.json',\n        '!node_modules/**',\n      ],\n      layerOptimization: {\n        cleanupPatterns: [\n          \"node_modules/**/*.pyc\",\n          \"node_modules/**/*.md\",\n        ]\n      }\n    };\n\n    this.commands = {\n      pip: `pip install -r ${this.default.dependenciesPath} -t .`,\n    };\n  }\n\n  init() {\n    const { dependenciesPath } = this.plugin.settings;\n\n    const localpackageJson = path.join(\n      process.cwd(),\n      dependenciesPath\n    );\n\n    try {\n      this.localPackage = fs.readFileSync(localpackageJson).toString();\n    } catch (e) {\n      this.plugin.log(`Error: Can not find ${localpackageJson}!`);\n      process.exit(1);\n    }\n  }\n\n  async isCompatibleVersion(runtime) {\n    const osVersion = await this.parent.run('python --version');\n    const [runtimeVersion] = runtime.match(/[0-9].[0-9]/);\n    return {\n      version: osVersion,\n      isCompatible: osVersion.startsWith(`Python ${runtimeVersion}`)\n    };\n  }\n\n  isDiff(depsA, depsB) {\n    if (!depsA) {\n      return true;\n    }\n    return depsA !== depsB;\n  }\n\n  async hasDependenciesChanges() {\n    const remotePackage = await this.plugin.bucketService.downloadDependencesFile();\n\n    let isDifferent = true;\n\n    if (remotePackage) {\n      this.plugin.log(`Comparing ${this.default.dependenciesPath} dependencies...`);\n      isDifferent = await this.isDiff(remotePackage, this.localPackage);\n    }\n\n    return isDifferent;\n  }\n}\n\nmodule.exports = PythonRuntime;\n"],"mappings":"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"}