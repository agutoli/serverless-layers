{"version":3,"file":"index.js","names":["require","exec","ruby","nodejs","python","Runtimes","plugin","compatibleArchitectures","runtime","service","provider","error","process","exit","patterns","env","test","_runtime","log","isCompatibleVersion","then","data","isCompatible","warn","version","replace","init","cmd","Promise","resolve","reject","err","stdout","out","inboundSettings","packagePath","console","dependenciesPath","commands","hasDependenciesChanges","module","exports"],"sources":["../../src/runtimes/index.js"],"sourcesContent":["const { exec } = require('child_process');\n\nconst ruby = require('./ruby');\nconst nodejs = require('./nodejs');\nconst python = require('./python');\n\nclass Runtimes {\n  constructor(plugin) {\n    this.plugin = plugin;\n    this.compatibleArchitectures = [\"x86_64\",\"arm64\"];\n\n    const { runtime } = this.plugin.service.provider;\n\n    if (!runtime) {\n      this.plugin.error('service.provider.runtime is required!');\n      return process.exit(1);\n    }\n\n    const patterns = {\n      python: [/python/, python],\n      nodejs: [/node/, nodejs],\n      ruby: [/ruby/, ruby],\n    };\n\n    for (const env in patterns) {\n      if (patterns[env][0].test(runtime)) {\n        this._runtime = new patterns[env][1](this, runtime, env);\n        break;\n      }\n    }\n\n    if (!this._runtime) {\n      this.plugin.log(`\"${runtime}\" runtime is not supported (yet).`);\n      return process.exit(1);\n    }\n\n    this._runtime.isCompatibleVersion(runtime)\n      .then((data) => {\n        if (!data.isCompatible) {\n          this.plugin.warn('=============================================================');\n          this.plugin.warn(`WARN: The current environment and Lambda runtime don't match (current=${data.version.replace('\\n', '')} vs runtime=${runtime}).`);\n          this.plugin.warn('=============================================================\\n');\n        }\n      });\n  }\n\n  init() {\n    this._runtime.init();\n  }\n\n  run(cmd) {\n    return new Promise((resolve, reject) => {\n      exec(cmd, (err, stdout, out) => {\n        if (err) return reject(err);\n        return resolve(stdout || out);\n      });\n    });\n  }\n\n  getDefaultSettings(inboundSettings = {}) {\n    if (inboundSettings.packagePath) {\n      console.warn('WARN You should use \"dependenciesPath\" instead of the deprecated \"packagePath\" param.');\n      inboundSettings.dependenciesPath = inboundSettings.packagePath;\n    }\n    return { ...this._runtime.default, ...inboundSettings };\n  }\n\n  getCommands() {\n    return this._runtime.commands;\n  }\n\n  hasDependenciesChanges() {\n    return this._runtime.hasDependenciesChanges();\n  }\n}\n\nmodule.exports = Runtimes;\n"],"mappings":";;;;;;;;AAAA,eAAiBA,OAAO,CAAC,eAAe,CAAC;EAAjCC,IAAI,YAAJA,IAAI;AAEZ,IAAMC,IAAI,GAAGF,OAAO,CAAC,QAAQ,CAAC;AAC9B,IAAMG,MAAM,GAAGH,OAAO,CAAC,UAAU,CAAC;AAClC,IAAMI,MAAM,GAAGJ,OAAO,CAAC,UAAU,CAAC;AAAC,IAE7BK,QAAQ;EACZ,kBAAYC,MAAM,EAAE;IAAA;IAAA;IAClB,IAAI,CAACA,MAAM,GAAGA,MAAM;IACpB,IAAI,CAACC,uBAAuB,GAAG,CAAC,QAAQ,EAAC,OAAO,CAAC;IAEjD,IAAQC,OAAO,GAAK,IAAI,CAACF,MAAM,CAACG,OAAO,CAACC,QAAQ,CAAxCF,OAAO;IAEf,IAAI,CAACA,OAAO,EAAE;MACZ,IAAI,CAACF,MAAM,CAACK,KAAK,CAAC,uCAAuC,CAAC;MAC1D,OAAOC,OAAO,CAACC,IAAI,CAAC,CAAC,CAAC;IACxB;IAEA,IAAMC,QAAQ,GAAG;MACfV,MAAM,EAAE,CAAC,QAAQ,EAAEA,MAAM,CAAC;MAC1BD,MAAM,EAAE,CAAC,MAAM,EAAEA,MAAM,CAAC;MACxBD,IAAI,EAAE,CAAC,MAAM,EAAEA,IAAI;IACrB,CAAC;IAED,KAAK,IAAMa,GAAG,IAAID,QAAQ,EAAE;MAC1B,IAAIA,QAAQ,CAACC,GAAG,CAAC,CAAC,CAAC,CAAC,CAACC,IAAI,CAACR,OAAO,CAAC,EAAE;QAClC,IAAI,CAACS,QAAQ,GAAG,IAAIH,QAAQ,CAACC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,EAAEP,OAAO,EAAEO,GAAG,CAAC;QACxD;MACF;IACF;IAEA,IAAI,CAAC,IAAI,CAACE,QAAQ,EAAE;MAClB,IAAI,CAACX,MAAM,CAACY,GAAG,aAAKV,OAAO,wCAAoC;MAC/D,OAAOI,OAAO,CAACC,IAAI,CAAC,CAAC,CAAC;IACxB;IAEA,IAAI,CAACI,QAAQ,CAACE,mBAAmB,CAACX,OAAO,CAAC,CACvCY,IAAI,CAAC,UAACC,IAAI,EAAK;MACd,IAAI,CAACA,IAAI,CAACC,YAAY,EAAE;QACtB,KAAI,CAAChB,MAAM,CAACiB,IAAI,CAAC,+DAA+D,CAAC;QACjF,KAAI,CAACjB,MAAM,CAACiB,IAAI,iFAA0EF,IAAI,CAACG,OAAO,CAACC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,yBAAejB,OAAO,QAAK;QACnJ,KAAI,CAACF,MAAM,CAACiB,IAAI,CAAC,iEAAiE,CAAC;MACrF;IACF,CAAC,CAAC;EACN;EAAC;IAAA;IAAA,OAED,gBAAO;MACL,IAAI,CAACN,QAAQ,CAACS,IAAI,EAAE;IACtB;EAAC;IAAA;IAAA,OAED,aAAIC,GAAG,EAAE;MACP,OAAO,IAAIC,OAAO,CAAC,UAACC,OAAO,EAAEC,MAAM,EAAK;QACtC7B,IAAI,CAAC0B,GAAG,EAAE,UAACI,GAAG,EAAEC,MAAM,EAAEC,GAAG,EAAK;UAC9B,IAAIF,GAAG,EAAE,OAAOD,MAAM,CAACC,GAAG,CAAC;UAC3B,OAAOF,OAAO,CAACG,MAAM,IAAIC,GAAG,CAAC;QAC/B,CAAC,CAAC;MACJ,CAAC,CAAC;IACJ;EAAC;IAAA;IAAA,OAED,8BAAyC;MAAA,IAAtBC,eAAe,uEAAG,CAAC,CAAC;MACrC,IAAIA,eAAe,CAACC,WAAW,EAAE;QAC/BC,OAAO,CAACb,IAAI,CAAC,uFAAuF,CAAC;QACrGW,eAAe,CAACG,gBAAgB,GAAGH,eAAe,CAACC,WAAW;MAChE;MACA,uCAAY,IAAI,CAAClB,QAAQ,WAAQ,GAAKiB,eAAe;IACvD;EAAC;IAAA;IAAA,OAED,uBAAc;MACZ,OAAO,IAAI,CAACjB,QAAQ,CAACqB,QAAQ;IAC/B;EAAC;IAAA;IAAA,OAED,kCAAyB;MACvB,OAAO,IAAI,CAACrB,QAAQ,CAACsB,sBAAsB,EAAE;IAC/C;EAAC;EAAA;AAAA;AAGHC,MAAM,CAACC,OAAO,GAAGpC,QAAQ"}